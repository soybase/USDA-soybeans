var animint=function(to_select,json_file){var dirs=json_file.split("/");dirs.pop();var element=d3.select(to_select);this.element=element;var Widgets={};this.Widgets=Widgets;var Selectors={};this.Selectors=Selectors;var Plots={};this.Plots=Plots;var Geoms={};this.Geoms=Geoms;var SVGs={};this.SVGs=SVGs;var Animation={};this.Animation=Animation;var all_geom_names={};this.all_geom_names=all_geom_names;var css=document.createElement("style");css.type="text/css";var styles=[".axis path{fill: none;stroke: black;shape-rendering: crispEdges;}",".axis line{fill: none;stroke: black;shape-rendering: crispEdges;}",".axis text {font-family: sans-serif;font-size: 11px;}"],margin={left:0,right:10,top:10,bottom:0},plotdim={width:0,height:0,xstart:0,xend:0,ystart:0,yend:0,graph:{width:0,height:0},margin:margin,xlab:{x:0,y:0},ylab:{x:0,y:0},title:{x:0,y:0}},add_geom=function(g_name,g_info){g_info.aes.hasOwnProperty("fill")&&"rect"==g_info.geom&&g_info.aes.hasOwnProperty("clickSelects")?g_info.select_style="stroke":g_info.select_style="opacity",g_info.tr=Widgets.loading.append("tr"),g_info.tr.append("td").text(g_name),g_info.tr.append("td").attr("class","chunk"),g_info.tr.append("td").attr("class","downloaded").text(0),g_info.tr.append("td").text(g_info.total),g_info.tr.append("td").attr("class","status").text("initialized"),g_info.data={},g_info.download_status={},Geoms[g_name]=g_info,update_geom(g_name,null)},add_plot=function(p_name,p_info){var plot_tr=element.append("table").style("display","inline-block").append("tr"),tdLeft=plot_tr.append("td"),svg=(plot_tr.append("td").attr("id",p_name+"_legend"),tdLeft.append("svg").attr("id",p_name).attr("height",p_info.options.height).attr("width",p_info.options.width)),nrows=Math.max.apply(null,p_info.layout.ROW),ncols=Math.max.apply(null,p_info.layout.COL),panel_names=p_info.layout.PANEL,npanels=Math.max.apply(null,panel_names),titlepadding=measureText(p_info.title,20).height+10;void 0===p_info.title&&(titlepadding=0),plotdim.title.x=p_info.options.width/2,plotdim.title.y=titlepadding/2,svg.append("text").text(p_info.title).attr("id","plottitle").attr("class","title").attr("font-family","sans-serif").attr("font-size","20px").attr("transform","translate("+plotdim.title.x+","+plotdim.title.y+")").style("text-anchor","middle");var xtitlepadding=5+measureText(p_info.xtitle,11).height,ytitlepadding=5+measureText(p_info.ytitle,11).height,axispaddingy=5;p_info.hasOwnProperty("ylabs")&&p_info.ylabs.length&&(axispaddingy+=Math.max.apply(null,p_info.ylabs.map(function(entry){return measureText(entry,11).width})));var axispaddingx=30;p_info.hasOwnProperty("xlabs")&&p_info.xlabs.length&&(axispaddingx+=Math.max.apply(null,p_info.xlabs.map(function(entry){return measureText(entry,11,p_info.xangle).height})),margin.right+=5);var strip_height=Math.max.apply(null,p_info.strips.top.map(function(entry){return measureText(entry,11).height})),strip_width=Math.max.apply(null,p_info.strips.right.map(function(entry){return measureText(entry,11).height}));plotdim.margin=margin;for(var n_xaxes=0,n_yaxes=0,layout_i=0;layout_i<npanels;layout_i++)1==p_info.layout.COL[layout_i]&&(n_xaxes+=p_info.layout.AXIS_X[layout_i]),1==p_info.layout.ROW[layout_i]&&(n_yaxes+=p_info.layout.AXIS_Y[layout_i]);var graph_width=p_info.options.width-ncols*(margin.left+margin.right)-p_info.strips.n.right*strip_width-n_yaxes*axispaddingy-ytitlepadding,graph_height=p_info.options.height-nrows*(margin.top+margin.bottom)-titlepadding-p_info.strips.n.top*strip_height-n_xaxes*axispaddingx-xtitlepadding;if(p_info.layout.coord_fixed[0])var aspect=graph_height/nrows/(graph_width/ncols);else aspect=1;var wp=p_info.layout.width_proportion.map(function(x){return x*Math.min(1,aspect)}),hp=p_info.layout.height_proportion.map(function(x){return x*Math.min(1,1/aspect)}),graph_height_blank=1,graph_width_blank=1;for(layout_i=0;layout_i<npanels;layout_i++)1==p_info.layout.COL[layout_i]&&(graph_height_blank-=hp[layout_i]),1==p_info.layout.ROW[layout_i]&&(graph_width_blank-=wp[layout_i]);var graph_width_cum=graph_width_blank/2*graph_width,graph_height_cum=graph_height_blank/2*graph_height;svg.plot=p_info,(Plots[p_name]=p_info).geoms.forEach(function(g_name){var layer_g_element=svg.append("g").attr("class",g_name);panel_names.forEach(function(PANEL){layer_g_element.append("g").attr("class","PANEL"+PANEL)}),SVGs[g_name]=svg}),1<npanels&&(svg.append("g").attr("class","strip").attr("id","topStrip"),svg.append("g").attr("class","strip").attr("id","rightStrip"));var scales={};for(layout_i=n_yaxes=n_xaxes=0;layout_i<npanels;layout_i++){var outbreaks,outlabs,panel_i=layout_i+1,axis=p_info["axis"+panel_i],xaxisvals=[],xaxislabs=[],yaxisvals=[],yaxislabs=[],axislabs=function(breaks,labs,axis){if(outlabs="x"==axis?(outbreaks=xaxisvals,xaxislabs):(outbreaks=yaxisvals,yaxislabs),isArray(breaks))breaks.forEach(function(d){outbreaks.push(d)});else for(key in breaks)outbreaks.push(breaks[key]);labs?labs.forEach(function(d){outlabs.push(d)}):outbreaks.forEach(function(d){outlabs.push("")})};axislabs(axis.x,axis.xlab,"x"),axislabs(axis.y,axis.ylab,"y"),plotdim.graph.height=graph_height*hp[layout_i],plotdim.graph.width=graph_width*wp[layout_i];var current_row=p_info.layout.ROW[layout_i],current_col=p_info.layout.COL[layout_i],draw_x=p_info.layout.AXIS_X[layout_i],draw_y=p_info.layout.AXIS_Y[layout_i];current_col<=p_info.layout.COL[layout_i-1]&&(n_yaxes=0,graph_width_cum=graph_width_blank/2*graph_width,graph_height_cum+=plotdim.graph.height),n_xaxes+=draw_x,n_yaxes+=draw_y,plotdim.xstart=current_col*plotdim.margin.left+(current_col-1)*plotdim.margin.right+graph_width_cum+n_yaxes*axispaddingy+ytitlepadding,plotdim.xend=plotdim.xstart+plotdim.graph.width,plotdim.ystart=current_row*(plotdim.margin.top+strip_height)+(current_row-1)*plotdim.margin.bottom+graph_height_cum+titlepadding+Math.min(p_info.strips.n.top,current_row)*strip_height,plotdim.yend=plotdim.ystart+plotdim.graph.height,graph_width_cum+=plotdim.graph.width,0===layout_i&&svg.append("text").text(p_info.ytitle).attr("class","label").attr("id","ytitle").style("text-anchor","middle").style("font-size","11px").attr("transform","translate("+(plotdim.xstart-axispaddingy-ytitlepadding/2)+","+p_info.options.height/2+")rotate(270)"),layout_i===npanels-1&&svg.append("text").text(p_info.xtitle).attr("class","label").attr("id","xtitle").style("text-anchor","middle").style("font-size","11px").attr("transform","translate("+plotdim.title.x+","+(plotdim.yend+axispaddingx)+")");var draw_strip=function(strip,side){if(""==strip)return null;var x=(plotdim.xstart+plotdim.xend)/2,y=plotdim.ystart-strip_height/2,rotate=0;"right"==side&&(x=plotdim.xend+strip_width/2,y=(plotdim.ystart+plotdim.yend)/2,rotate=90),svg.select("#"+side+"Strip").selectAll("."+side+"Strips").data(strip).enter().append("text").style("text-anchor","middle").style("font-size","11px").text(function(d){return d}).attr("transform","translate("+x+","+y+")rotate("+rotate+")")};if(draw_strip([p_info.strips.top[layout_i]],"top"),draw_strip([p_info.strips.right[layout_i]],"right"),scales[panel_i]={},scales[panel_i].x=d3.scale.linear().domain([0,1]).range([plotdim.xstart,plotdim.xend]),scales[panel_i].x_fake=d3.scale.linear().domain(axis.xrange).range([plotdim.xstart,plotdim.xend]),scales[panel_i].y=d3.scale.linear().domain([0,1]).range([plotdim.yend,plotdim.ystart]),scales[panel_i].y_fake=d3.scale.linear().domain([axis.yrange[1],axis.yrange[0]]).range([plotdim.ystart,plotdim.yend]),draw_x){var xaxis=d3.svg.axis().scale(scales[panel_i].x).tickValues(xaxisvals).tickFormat(function(d){return xaxislabs[xaxisvals.indexOf(d)].toString()}).orient("bottom");svg.append("g").attr("class","axis").attr("id","xaxis").attr("transform","translate(0,"+plotdim.yend+")").call(xaxis).selectAll("text").style("text-anchor",p_info.xanchor).attr("transform","rotate("+p_info.xangle+" 0 9)")}if(draw_y){var yaxis=d3.svg.axis().scale(scales[panel_i].y).tickValues(yaxisvals).tickFormat(function(d){return yaxislabs[yaxisvals.indexOf(d)].toString()}).orient("left");svg.append("g").attr("class","axis").attr("id","yaxis").attr("transform","translate("+plotdim.xstart+",0)").call(yaxis)}axis.xline||styles.push("#"+p_name+" #xaxis path{stroke:none;}"),axis.xticks||styles.push("#"+p_name+" #xaxis .tick line{stroke:none;}"),axis.yline||styles.push("#"+p_name+" #yaxis path{stroke:none;}"),axis.yticks||styles.push("#"+p_name+" #yaxis .tick line{stroke:none;}")}Plots[p_name].scales=scales},add_selector=function(s_name,s_info){"multiple"==(Selectors[s_name]=s_info).type&&(isArray(s_info.selected)||(s_info.selected=[s_info.selected]))},get_tsv=function(g_info,chunk_id){return g_info.classed+"_chunk"+chunk_id+".tsv"},update_geom=function(g_name,selector_name){var g_info=Geoms[g_name],chunk_id=g_info.chunks;if(g_info.chunk_order.forEach(function(v_name){if(null!=chunk_id){var value=Selectors[v_name].selected;chunk_id=chunk_id.hasOwnProperty(value)?chunk_id[value]:null}}),null!=chunk_id){var tsv_name=get_tsv(g_info,chunk_id);if(g_info.tr.select("td.chunk").text(tsv_name),g_info.data.hasOwnProperty(tsv_name))draw_panels(g_info,g_info.data[tsv_name],selector_name);else{g_info.tr.select("td.status").text("downloading");var loading=SVGs[g_name].append("text").attr("class","loading"+tsv_name).text("Downloading "+tsv_name+"...").attr("font-size",9).attr("y",10).style("fill","red");download_chunk(g_info,tsv_name,function(chunk){loading.remove(),draw_panels(g_info,chunk,selector_name)})}}else draw_panels(g_info,[],selector_name)},draw_panels=function(g_info,chunk,selector_name){var g_names=g_info.classed.split("_"),p_name=g_names[g_names.length-1];Plots[p_name].layout.PANEL.forEach(function(panel){draw_geom(g_info,chunk,selector_name,panel)})},download_next=function(g_name){var g_info=Geoms[g_name],selector_value=g_info.seq[g_info.seq_i],chunk_id=g_info.chunks[selector_value],tsv_name=get_tsv(g_info,chunk_id);g_info.seq_count+=1,g_info.seq_count>g_info.seq.length||(g_info.seq_i+=1,g_info.seq_i==g_info.seq.length&&(g_info.seq_i=0),download_chunk(g_info,tsv_name,function(chunk){download_next(g_name)}))},download_chunk=function(g_info,tsv_name,funAfter){if(g_info.download_status.hasOwnProperty(tsv_name))funAfter();else{g_info.download_status[tsv_name]="downloading";var tsv_file=dirs.concat(tsv_name).join("/");d3.tsv(tsv_file,function(error,response){g_info.download_status[tsv_name]="processing",response.forEach(function(d){for(var v_name in g_info.types)if(!is_interactive_aes(v_name)){var r_type=g_info.types[v_name];if("integer"==r_type)d[v_name]=parseInt(d[v_name]);else if("numeric"==r_type)d[v_name]=parseFloat(d[v_name]);else if("factor"==r_type);else if("rgb"==r_type);else if("linetype"==r_type);else if("label"==r_type);else if("character"==r_type);else{if(!("character"==r_type&"outliers"==v_name))throw"unsupported R type "+r_type;d[v_name]=parseFloat(d[v_name].split(" @ "))}}});var nest=d3.nest();g_info.nest_order.forEach(function(v_name){nest.key(function(d){return d[v_name]})});var chunk=nest.map(response);g_info.data[tsv_name]=chunk,g_info.tr.select("td.downloaded").text(d3.keys(g_info.data).length),g_info.download_status[tsv_name]="saved",funAfter(chunk)})}function is_interactive_aes(v_name){return-1<v_name.indexOf("clickSelects")||-1<v_name.indexOf("showSelected")}},draw_geom=function(g_info,chunk,selector_name,PANEL){g_info.tr.select("td.status").text("displayed");var svg=SVGs[g_info.classed],g_names=g_info.classed.split("_"),p_name=g_names[g_names.length-1],scales=Plots[p_name].scales[PANEL],selected_arrays=[[]];g_info.subset_order.forEach(function(aes_name){var selected,values,new_array;if("PANEL"==aes_name)selected=PANEL;else{var v_name=g_info.aes[aes_name];selected=Selectors[v_name].selected}values=isArray(selected)?selected:[selected];var new_arrays=[];values.forEach(function(value){selected_arrays.forEach(function(old_array){new_array=old_array.concat(value),new_arrays.push(new_array)})}),selected_arrays=new_arrays});var data=[];selected_arrays.forEach(function(value_array){var some_data=chunk;if(value_array.forEach(function(value){some_data=some_data.hasOwnProperty(value)?some_data[value]:[]}),isArray(some_data))data=data.concat(some_data);else for(k in isArray(data)&&(data={}),some_data)data[k]=some_data[k]});var aes=g_info.aes,toXY=function(xy,a){return function(d){return scales[xy](d[a])}},elements=svg.select("g."+g_info.classed).select("g.PANEL"+PANEL).selectAll(".geom"),base_opacity=1;g_info.params.alpha&&(base_opacity=g_info.params.alpha);var get_alpha=function(d){return aes.hasOwnProperty("alpha")&&d.hasOwnProperty("alpha")?d.alpha:base_opacity},size=2;"text"==g_info.geom&&(size=12),g_info.params.hasOwnProperty("size")&&(size=g_info.params.size);var get_size=function(d){return aes.hasOwnProperty("size")&&d.hasOwnProperty("size")?d.size:size},linetype="solid";g_info.params.linetype&&(linetype=g_info.params.linetype);var get_dasharray=function(d){var lt;if(aes.hasOwnProperty("linetype")&&d.hasOwnProperty("linetype"))try{lt=d.linetype}catch(err){lt=g_info.params.linetype}else lt=linetype;return linetypesize2dasharray(lt,get_size(d))},colour="black",fill="black",get_colour=function(d){return d.hasOwnProperty("colour")?d.colour:colour},get_fill=function(d){return d.hasOwnProperty("fill")?d.fill:fill};g_info.params.colour&&(colour=g_info.params.colour),g_info.params.fill?fill=g_info.params.fill:g_info.params.colour&&(fill=g_info.params.colour);var eActions,eAppend,text_anchor="middle",get_text_anchor=function(d){return hjust=g_info.params.hjust,d.hasOwnProperty("hjust")&&(hjust=d.hjust),0==hjust&&(text_anchor="start"),.5==hjust&&(text_anchor="middle"),1==hjust&&(text_anchor="end"),text_anchor},key_fun=null,id_fun=function(d){return d.id};if(g_info.aes.hasOwnProperty("key")&&(key_fun=function(d){return d.key}),"line"==g_info.geom||"path"==g_info.geom||"polygon"==g_info.geom||"ribbon"==g_info.geom){if(aes.hasOwnProperty("group")){var kv=d3.entries(d3.keys(data));kv=kv.map(function(d){return d.clickSelects=data[d.value][0].clickSelects,d})}else 0==data.length?kv=[]:(kv=[{key:0,value:0}],data={0:data});if("ribbon"==g_info.geom)var lineThing=d3.svg.area().x(toXY("x","x")).y(toXY("y","ymax")).y0(toXY("y","ymin"));else lineThing=d3.svg.line().x(toXY("x","x")).y(toXY("y","y"));null!=key_fun&&(key_fun=function(group_info){return data[group_info.value][0].key}),id_fun=function(group_info){return data[group_info.value][0].id},elements=elements.data(kv,key_fun),eActions=function(e){e.attr("d",function(d){var no_na=data[d.value].filter(function(d){return"ribbon"==g_info.geom?!isNaN(d.x)&&!isNaN(d.ymin)&&!isNaN(d.ymax):!isNaN(d.x)&&!isNaN(d.y)});return lineThing(no_na)}).style("fill",function(group_info){if("line"==g_info.geom||"path"==g_info.geom)return"none";var one_row=data[group_info.value][0];return get_fill(one_row)}).style("stroke-width",function(group_info){var one_row=data[group_info.value][0];return get_size(one_row)}).style("stroke",function(group_info){var one_row=data[group_info.value][0];return get_colour(one_row)}).style("stroke-dasharray",function(group_info){var one_row=data[group_info.value][0];return get_dasharray(one_row)}).style("stroke-width",function(group_info){var one_row=data[group_info.value][0];return get_size(one_row)})},eAppend="path"}else if("segment"==g_info.geom)elements=elements.data(data,key_fun),eActions=function(e){e.attr("x1",function(d){return scales.x(d.x)}).attr("x2",function(d){return scales.x(d.xend)}).attr("y1",function(d){return scales.y(d.y)}).attr("y2",function(d){return scales.y(d.yend)}).style("stroke-dasharray",get_dasharray).style("stroke-width",get_size).style("stroke",get_colour)},eAppend="line";else if("linerange"==g_info.geom)elements=elements.data(data,key_fun),eActions=function(e){e.attr("x1",function(d){return scales.x(d.x)}).attr("x2",function(d){return scales.x(d.x)}).attr("y1",function(d){return scales.y(d.ymax)}).attr("y2",function(d){return scales.y(d.ymin)}).style("stroke-dasharray",get_dasharray).style("stroke-width",get_size).style("stroke",get_colour)},eAppend="line";else if("vline"==g_info.geom)elements=elements.data(data,key_fun),eActions=function(e){e.attr("x1",toXY("x","xintercept")).attr("x2",toXY("x","xintercept")).attr("y1",scales.y.range()[0]).attr("y2",scales.y.range()[1]).style("stroke-dasharray",get_dasharray).style("stroke-width",get_size).style("stroke",get_colour)},eAppend="line";else if("hline"==g_info.geom)elements=elements.data(data,key_fun),eActions=function(e){e.attr("y1",toXY("y","yintercept")).attr("y2",toXY("y","yintercept")).attr("x1",scales.x.range()[0]+plotdim.margin.left).attr("x2",scales.x.range()[1]-plotdim.margin.right).style("stroke-dasharray",get_dasharray).style("stroke-width",get_size).style("stroke",get_colour)},eAppend="line";else if("text"==g_info.geom)elements=elements.data(data,key_fun),eActions=function(e){e.attr("x",toXY("x","x")).attr("y",toXY("y","y")).style("fill",get_colour).attr("font-size",get_size).style("text-anchor",get_text_anchor).text(function(d){return d.label})},eAppend="text";else if("point"==g_info.geom)elements=elements.data(data,key_fun),eActions=function(e){e.attr("cx",toXY("x","x")).attr("cy",toXY("y","y")).attr("r",get_size).style("fill",get_fill).style("stroke",get_colour)},eAppend="circle";else if("jitter"==g_info.geom)elements=elements.data(data,key_fun),eActions=function(e){e.attr("cx",toXY("x","x")).attr("cy",toXY("y","y")).attr("r",get_size).style("fill",get_fill).style("stroke",get_colour)},eAppend="circle";else if("tallrect"==g_info.geom)elements=elements.data(data,key_fun),eActions=function(e){e.attr("x",toXY("x","xmin")).attr("width",function(d){return scales.x(d.xmax)-scales.x(d.xmin)}).attr("y",scales.y.range()[1]).attr("height",scales.y.range()[0]-scales.y.range()[1]).style("fill",get_fill).style("stroke-width",get_size).style("stroke",get_colour)},eAppend="rect";else if("widerect"==g_info.geom)elements=elements.data(data,key_fun),eActions=function(e){e.attr("y",toXY("y","ymin")).attr("height",function(d){return scales.x(d.ymax)-scales.x(d.ymin)}).attr("x",scales.x.range()[0]).attr("width",scales.x.range()[1]-scales.x.range()[0]).style("fill",get_fill).style("stroke-width",get_size).style("stroke",get_colour)},eAppend="rect";else if("rect"==g_info.geom)elements=elements.data(data,key_fun),eActions=function(e){e.attr("x",toXY("x","xmin")).attr("width",function(d){return Math.abs(scales.x(d.xmax)-scales.x(d.xmin))}).attr("y",toXY("y","ymax")).attr("height",function(d){return Math.abs(scales.y(d.ymin)-scales.y(d.ymax))}).style("stroke-dasharray",get_dasharray).style("stroke-width",get_size).style("fill",get_fill),"stroke"!=g_info.select_style&&e.style("stroke",get_colour)},eAppend="rect";else{if("boxplot"!=g_info.geom)return"unsupported geom "+g_info.geom;fill="white",elements=elements.data(data),eActions=function(e){e.append("line").attr("x1",function(d){return scales.x(d.x)}).attr("x2",function(d){return scales.x(d.x)}).attr("y1",function(d){return scales.y(d.ymin)}).attr("y2",function(d){return scales.y(d.lower)}).style("stroke-dasharray",get_dasharray).style("stroke-width",get_size).style("stroke",get_colour),e.append("line").attr("x1",function(d){return scales.x(d.x)}).attr("x2",function(d){return scales.x(d.x)}).attr("y1",function(d){return scales.y(d.upper)}).attr("y2",function(d){return scales.y(d.ymax)}).style("stroke-dasharray",get_dasharray).style("stroke-width",get_size).style("stroke",get_colour),e.append("rect").attr("x",function(d){return scales.x(d.xmin)}).attr("width",function(d){return scales.x(d.xmax)-scales.x(d.xmin)}).attr("y",function(d){return scales.y(d.upper)}).attr("height",function(d){return Math.abs(scales.y(d.upper)-scales.y(d.lower))}).style("stroke-dasharray",get_dasharray).style("stroke-width",get_size).style("stroke",get_colour).style("fill",get_fill),e.append("line").attr("x1",function(d){return scales.x(d.xmin)}).attr("x2",function(d){return scales.x(d.xmax)}).attr("y1",function(d){return scales.y(d.middle)}).attr("y2",function(d){return scales.y(d.middle)}).style("stroke-dasharray",get_dasharray).style("stroke-width",get_size).style("stroke",get_colour)}}elements.exit().remove();var enter=elements.enter();enter=g_info.aes.hasOwnProperty("href")?enter.append("svg:a").append("svg:"+eAppend):enter.append(eAppend).attr("class","geom");var has_clickSelects=g_info.aes.hasOwnProperty("clickSelects");if(has_clickSelects){var style_funs={opacity:{mouseout:function(d){return ifSelectedElse(d,g_info.aes.clickSelects,get_alpha(d),get_alpha(d)-.5)},mouseover:function(d){return get_alpha(d)}},stroke:{mouseout:function(d){return ifSelectedElse(d,g_info.aes.clickSelects,"black","transparent")},mouseover:function(d){return"black"}}}[g_info.select_style],over_fun=function(e){e.style(g_info.select_style,style_funs.mouseover)},out_fun=function(e){e.style(g_info.select_style,style_funs.mouseout)};elements.call(out_fun).on("mouseover",function(d){d3.select(this).call(over_fun)}).on("mouseout",function(d){d3.select(this).call(out_fun)}).on("click",function(d){var v_name=g_info.aes.clickSelects;update_selector(v_name,d.clickSelects)})}else"line"==g_info.geom||"ribbon"==g_info.geom?enter.style("opacity",function(group_info){var one_row=data[group_info.value][0];return get_alpha(one_row)}):enter.style("opacity",get_alpha);var has_tooltip=g_info.aes.hasOwnProperty("tooltip");if((has_clickSelects||has_tooltip)&&elements.text("").append("svg:title").text(function(d){return has_tooltip?d.tooltip:g_info.aes.clickSelects+" "+d.clickSelects}),eActions(enter),Selectors.hasOwnProperty(selector_name)){var milliseconds=Selectors[selector_name].duration;elements=elements.transition().duration(milliseconds)}(g_info.aes.hasOwnProperty("id")&&elements.attr("id",id_fun),g_info.aes.hasOwnProperty("href"))?(eActions(elements.select(eAppend)),elements.attr("xlink:href",function(d){return d.href}).attr("target","_blank").attr("class","geom")):eActions(elements)},update_selector=function(v_name,value){var s_info=Selectors[v_name];if(value+="","single"==s_info.type)s_info.selected=value;else{var i_value=s_info.selected.indexOf(value);-1==i_value?s_info.selected.push(value):s_info.selected.splice(i_value,1)}s_info.update.forEach(function(g_name){update_geom(g_name,v_name)})},ifSelectedElse=function(d,v_name,selected,not_selected){var value=d.clickSelects+"",s_info=Selectors[v_name];return("single"==s_info.type?value==s_info.selected:-1!=s_info.selected.indexOf(value))?selected:not_selected},animateIfLoaded=function(){var v_name=Animation.variable,cur=Selectors[v_name].selected,next=Animation.next[cur];all_geom_names.every(function(x){return-1!=d3.keys(Geoms).indexOf(x)})&&update_selector(v_name,next)},add_legend=function(p_name,p_info){for(var tdRight=element.select("td#"+p_name+"_legend"),legendkeys=d3.keys(p_info.legend),i=0;i<legendkeys.length;i++){var legend_table=tdRight.append("table").append("tr").append("th").attr("align","left").text(p_info.legend[legendkeys[i]].title),l_info=p_info.legend[legendkeys[i]],legendgeoms=l_info.geoms,legend_rows=legend_table.selectAll("tr").data(l_info.entries).sort(function(d){return d.order}).enter().append("tr"),legend_svgs=legend_rows.append("td").append("svg").attr("id",function(d){return"legend-"+d.label}).attr("height",14).attr("width",20),pointscale=d3.scale.linear().domain([0,7]).range([1,4]),linescale=d3.scale.linear().domain([0,6]).range([1,4]);-1<legendgeoms.indexOf("polygon")&&legend_svgs.append("rect").attr("x",2).attr("y",2).attr("width",10).attr("height",10).style("stroke-width",function(d){return d.polygonsize||1}).style("stroke-dasharray",function(d){return linetypesize2dasharray(d.polygonlinetype||"solid",d.size||2)}).style("stroke",function(d){return d.polygoncolour||"#000000"}).style("fill",function(d){return d.polygonfill||"#FFFFFF"}).style("opacity",function(d){return d.polygonalpha||1}),-1<legendgeoms.indexOf("text")&&legend_svgs.append("text").attr("x",10).attr("y",14).style("fill",function(d){return d.textcolour||1}).style("text-anchor","middle").attr("font-size",function(d){return d.textsize||1}).text("a"),-1<legendgeoms.indexOf("path")&&legend_svgs.append("line").attr("x1",1).attr("x2",19).attr("y1",7).attr("y2",7).style("stroke-width",function(d){return linescale(d.pathsize)||2}).style("stroke-dasharray",function(d){return linetypesize2dasharray(d.pathlinetype||"solid",d.pathsize||2)}).style("stroke",function(d){return d.pathcolour||"#000000"}).style("opacity",function(d){return d.pathalpha||1}),-1<legendgeoms.indexOf("point")&&legend_svgs.append("circle").attr("cx",10).attr("cy",7).attr("r",function(d){return pointscale(d.pointsize)||4}).style("stroke",function(d){return d.pointcolour||"#000000"}).style("fill",function(d){return d.pointfill||d.pointcolour||"#000000"}).style("opacity",function(d){return d.pointalpha||1}),legend_rows.append("td").attr("align","left").text(function(d){return d.label})}};d3.json(json_file,function(error,response){for(var p_name in response.hasOwnProperty("title")&&d3.select("title").text(response.title),response.plots)add_plot(p_name,response.plots[p_name]),add_legend(p_name,response.plots[p_name]),css.appendChild(document.createTextNode(styles.join(" "))),document.head.appendChild(css);for(var s_name in response.selectors)add_selector(s_name,response.selectors[s_name]);element.append("br");var show_hide_table=element.append("button").text("Show download status table");show_hide_table.on("click",function(){"Show download status table"==this.textContent?(loading.style("display",""),show_hide_table.text("Hide download status table")):(loading.style("display","none"),show_hide_table.text("Show download status table"))});var loading=element.append("table").style("display","none"),tr=(Widgets.loading=loading).append("tr");for(var g_name in tr.append("th").text("geom"),tr.append("th").attr("class","chunk").text("selected chunk"),tr.append("th").attr("class","downloaded").text("downloaded"),tr.append("th").attr("class","total").text("total"),tr.append("th").attr("class","status").text("status"),response.geoms)add_geom(g_name,response.geoms[g_name]);var show_hide_animation_controls=element.append("button").text("Show animation controls").attr("id","show_hide_animation_controls").on("click",function(){"Show animation controls"==this.textContent?(time_table.style("display",""),show_hide_animation_controls.text("Hide animation controls")):(time_table.style("display","none"),show_hide_animation_controls.text("Show animation controls"))}),time_table=element.append("table").style("display","none"),first_tr=time_table.append("tr"),first_th=first_tr.append("th");if(response.time&&(Animation.next={},Animation.ms=response.time.ms,Animation.variable=response.time.variable,Animation.sequence=response.time.sequence,Widgets.play_pause=first_th.append("button").attr("id","play_pause").on("click",function(){"Play"==this.textContent?play():pause()})),first_tr.append("th").text("milliseconds"),response.time){var second_tr=time_table.append("tr");second_tr.append("td").text("updates"),second_tr.append("td").append("input").attr("id","updates_ms").attr("type","text").attr("value",Animation.ms).on("change",function(){Animation.pause(),Animation.ms=this.value,Animation.play()})}for(s_name in Selectors){var s_info=Selectors[s_name];s_info.hasOwnProperty("duration")||(s_info.duration=0)}var selector_array=d3.keys(Selectors),duration_rows=time_table.selectAll("tr.duration").data(selector_array).enter().append("tr");duration_rows.append("td").text(function(s_name){return s_name});duration_rows.append("td").append("input").attr("id",function(s_name){return"duration_ms_"+s_name}).attr("type","text").on("change",function(s_name){Selectors[s_name].duration=this.value}).attr("value",function(s_name){return Selectors[s_name].duration});if(response.time){var prev,cur,timer;Selectors[Animation.variable].update.forEach(function(g_name){var g_info=Geoms[g_name];if(0!=g_info.chunk_order.length){if(1!=g_info.chunk_order.length)throw"do not know how to handle more than 1 chunk variable";g_info.chunk_order[0]==Animation.variable&&function(g_name,s_name,seq){var g_info=Geoms[g_name],s_info=Selectors[s_name];g_info.seq_i=seq.indexOf(s_info.selected),g_info.seq_count=0,g_info.seq=seq,download_next(g_name)}(g_name,Animation.variable,Animation.sequence)}});for(var i=0;i<Animation.sequence.length;i++)prev=0==i?Animation.sequence[Animation.sequence.length-1]:Animation.sequence[i-1],cur=Animation.sequence[i],Animation.next[prev]=cur;function play(){timer=setInterval(animateIfLoaded,Animation.ms),Widgets.play_pause.text("Pause")}function pause(){clearInterval(timer),Widgets.play_pause.text("Play")}all_geom_names=d3.keys(response.geoms),Animation.timer=timer,Animation.play=play,Animation.pause=pause,document.addEventListener("visibilitychange",function(evt){"hidden"==document.visibilityState?pause():play()}),Animation.play()}})},measureText=function(pText,pFontSize,pAngle,pStyle){if(!pText||0===pText.length)return{height:0,width:0};(null===pAngle||isNaN(pAngle))&&(pAngle=0);var container=d3.select("body").append("svg");container.append("text").attr({x:-1e3,y:-1e3}).attr("transform","rotate("+pAngle+")").attr("style",pStyle).attr("font-size",pFontSize).text(pText);var bbox=container.node().getBBox();return container.remove(),{height:bbox.height,width:bbox.width}},linetypesize2dasharray=function(lt,size){var n;if("number"!=typeof(n=lt)||parseFloat(n)!=parseInt(n,10)||isNaN(n))o={blank:0*size+","+10*size,none:0*size+","+10*size,solid:0,dashed:4*size+","+4*size,dotted:size+","+2*size,dotdash:size+","+2*size+","+4*size+","+2*size,longdash:8*size+","+4*size,twodash:2*size+","+2*size+","+6*size+","+2*size,22:2*size+","+2*size,42:4*size+","+2*size,44:4*size+","+4*size,13:size+","+3*size,1343:size+","+3*size+","+4*size+","+3*size,73:7*size+","+3*size,2262:2*size+","+2*size+","+6*size+","+2*size,12223242:size+","+2*size+","+2*size+","+2*size+","+3*size+","+2*size+","+4*size+","+2*size,F282:15*size+","+2*size+","+8*size+","+2*size,F4448444:15*size+","+4*size+","+4*size+","+4*size+","+8*size+","+4*size+","+4*size+","+4*size,"224282F2":2*size+","+2*size+","+4*size+","+2*size+","+8*size+","+2*size+","+16*size+","+2*size,F1:16*size+","+size};else var o={0:0*size+","+10*size,1:0,2:4*size+","+4*size,3:size+","+2*size,4:size+","+2*size+","+4*size+","+2*size,5:8*size+","+4*size,6:2*size+","+2*size+","+6*size+","+2*size};return lt in o?o[lt]:(str=lt.split(""),strnum=str.map(function(d){return size*parseInt(d,16)}),strnum)},isArray=function(o){return"[object Array]"===Object.prototype.toString.call(o)};
